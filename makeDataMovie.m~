function makeDataMovie(vid_path,v,S,mov_path,imVis,movType,varargin)


%% Parameters

% Video quality
vidQuality = 50;

% Invert image
imInvert = 0;

% Downsample roi
dSample = 0;

% Number of point for roi circle
numroipts = 300;

% Marker size in roi
mSize(1) = 2000;

% Marker size in whole frame
mSize(2) = 300;

% Color 
clrs{1} = [241 90 36]./255;

% Color around roi
clrs{2} = [41 171 226]./255;

% Color around tube feet
clrs{3} = [0 1 0];


%% Intializing things


% Set up output video file
vOut = VideoWriter([mov_path '.mp4'],'MPEG-4');
vOut.Quality = 50;
open(vOut)

% Make figure
f = figure('Visible',imVis);
fPos = get(f,'Position');
set(f,'Position',[fPos(1) fPos(2) 1020 1271])



%% Creat output


% Loop thru data
for i = 1:length(S.frames)
    
    % Current whole frame
    im = getFrame(vid_path,v,S.frames(i),imInvert,'rgb');
       
    if strcmp(movType,'two view')
        
        % Coordinate origin
        %cOrigin = [S.xCntr(i); S.yCntr(i)];
        
        % Get roi image
        [im_roi,bw_mask] = giveROI('stabilized',im,S.roi(i),...
            dSample,S.tform(i));
        
%         % Loop thru tube feet
%         for j = 1:length(S.ft)
%             
%             % Global tip point
%             tipG(j,:) = [S.ft(j).xTip(i) S.ft(j).yTip(i)];
%               
%             % Local tip point
%             tipL(j,:) = [S.ft(j).xTipL(i) S.ft(j).yTipL(i)];
%             
%             % Glocal base point
%             baseG(j,:) = [S.ft(j).xBase(i) S.ft(j).xBase(i)];
%             
%             % Local base point
%             baseL(j,:) = [S.ft(j).xBaseL(i) S.ft(j).xBaseL(i)];
%         end
        
        % Local tip point
        %tipL = G2L(cOrigin,-S.ang(i)/180*pi,tipG);
        
        % Tip point in region of interest
%         tipROI(1,:) = tipL(1,:) + size(im_roi,1)/2;
%         tipROI(2,:) = tipL(2,:) + size(im_roi,2)/2;
%         tipROI(1,:) = S.ft(j).xTipL + size(im_roi,1)/2;
%         tipROI(2,:) = S.ft(j).yTipL + size(im_roi,2)/2;
        
        % Plot image
        %figure(f)
        
        % Top image
        subplot(2,1,1)
        h = imshow(im,'InitialMag','fit');
        %title(['Frame ' num2str(S.frames(i))])
        a1 = gca;
        hold on      
        
        % Outline roi (global)
        line(S.roi(i).xPerimG,S.roi(i).yPerimG,'Color',...
            [clrs{2} 0.5],'LineWidth',1); 
        
            
%         scatter(tipG(1,:),tipG(2,:),'MarkerEdgeColor',clrs{3},...
%             'LineWidth',1,'MarkerEdgeAlpha',0.5,'SizeData',mSize(2));
        
        
        
        % BOTTOM IMAGE  ---------------------
        subplot(2,1,2)
        
        h = imshow(im_roi,'InitialMag','fit');
        a2 = gca;
        hold on
        
         % Set position of both images
        set(a1,'Position',[0 0.27 1 1])
        
        % Add frame number
        axes(a2); 
        h = text(1,30,['Frame ' num2str(S.frames(i))],...
                      'Color','k','FontSize',22,'FontWeight','bold','Parent',a2);
        
        %set(a2,'Position',[0.2 -.05 0.65 0.65])
        set(a2,'Position',[0.25 0 0.5 0.5])
        
        axes(a2)
        
        % Loop thru tube feet 
        for j = 1:length(S.ft)
            
            % Top plot
            %axes(a1)
            
            line([S.ft(j).xBase(i) S.ft(j).xTip(i)],...
                 [S.ft(j).yBase(i) S.ft(j).yTip(i)],...
                 'Color',[clrs{3} 0.3],'LineWidth',5,'Parent',a1);
            scatter(S.ft(j).xTip(i),S.ft(j).yTip(i),...
                    'MarkerFaceColor',clrs{3},...
                    'MarkerEdgeColor',clrs{3},'LineWidth',2,...
                    'MarkerEdgeAlpha',0.8,'MarkerFaceAlpha',0.8,...
                    'SizeData',100,'Parent',a1); 
               
            % Bottom plot
            
            
            % Tip plot in roi
            tipR = [S.ft(j).xTipL(i) + size(im_roi,1)/2 ...
                    S.ft(j).yTipL(i) + size(im_roi,2)/2];
                
           % Highlight foot
           scatter(tipR(1),tipR(2),'MarkerEdgeColor',clrs{3},...
               'LineWidth',2,'MarkerEdgeAlpha',0.5,'SizeData',mSize(1),...
               'Parent',a2);     
        end
        
%         scatter(tipROI(1,:),tipROI(2,:),'MarkerEdgeColor',clrs{3},...
%             'LineWidth',2,'MarkerEdgeAlpha',0.5,'SizeData',mSize(1));
        axes(a1)
        hold off
        
        axes(a2)
        hold off

        clear tipG tipROI
    end
    
    % Get image
    imFrame = getframe(gcf);
    
    % Write frame
    writeVideo(vOut,imFrame);
    
    if ~imVis
       disp(['DataMovie: Done ' num2str(i) ' of ' num2str(length(S.frames)) ' frames'])
    end
end

close(f)

% Output
%varargout{1} = M;
%varargout{1} = [];

close(vOut)


